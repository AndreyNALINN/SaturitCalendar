<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Управление бригадами и складом</title>
    <style>
        :root {
            --tab-bar-height: 70px; /* Высота нижней панели навигации */
        }

        * {
            box-sizing: border-box;
        }
        
        html {
            width: 100%;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #1d1d1f;
            font-size: 14px;
            padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom));
        }
        
        *:not(script):not(style) {
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        }
        
        input, textarea, select {
            -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            transition: all 0.3s ease;
            transform-origin: top;
        }
        
        .header.hidden {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
            transform: scaleY(0);
            z-index: -1;
        }
        
        .header h1 {
            margin: 0; color: #1d1d1f; font-size: 16px; font-weight: 600; flex: 1; min-width: 120px;
        }
        
        .user-info {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;
        }
        
        .logout-btn {
            background: #ff3b30; color: white; border: none; padding: 8px 14px; border-radius: 15px; cursor: pointer; font-size: 13px; transition: all 0.3s ease; min-height: 40px;
        }

        .logout-btn:hover {
            background: #d70015; transform: translateY(-2px);
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); overflow: hidden;
        }
        
        .tabs {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--tab-bar-height); display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(248, 249, 250, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom);
        }
        
        .tab {
            padding: 4px; text-align: center; cursor: pointer; border: none; background: transparent; font-size: 11px; font-weight: 500; color: #6c757d; transition: all 0.3s ease; position: relative; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; border-top: 3px solid transparent;
        }
        .tab span:first-child {
            font-size: 20px;
        }
        
        .tab.active {
            color: #667eea; border-top-color: #667eea;
        }
        
        .tab:hover:not(.active) {
            background: rgba(233, 236, 239, 0.5); color: #495057;
        }
        
        .tab-content {
            display: none; padding: 15px; animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .calendar {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9ecef; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); margin-bottom: 1px;
        }
        
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9ecef; border-radius: 0 0 8px 8px; overflow: hidden;
        }
        
        .calendar-header {
            text-align: center; font-weight: 600; padding: 10px 4px; background: #667eea; color: white; font-size: 12px;
        }
        
        .calendar-day {
            background: white; padding: 2px; aspect-ratio: 1 / 1.8; overflow: hidden; position: relative; cursor: pointer; transition: background 0.2s ease; display: flex; flex-direction: column;
        }

        .calendar-day:hover {
            transform: scale(1.02); z-index: 10;
        }
        
        .calendar-day.today::after {
            content: '';
            position: absolute;
            top: 1px; left: 1px; right: 1px; bottom: 1px;
            box-shadow: inset 0 0 0 2px #007aff;
            z-index: 6;
            pointer-events: none;
            border-radius: 1px;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa; color: #adb5bd; cursor: default;
        }
        .calendar-day.other-month:hover {
            transform: none;
        }
        
        .day-number {
            font-weight: 600; font-size: 10px; line-height: 1; align-self: flex-start; padding: 2px; color: #333; position: relative; z-index: 5;
        }
        
        .events-container {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 2px;
        }

        .work-events-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column;
        }

        .vacation-events-wrapper {
            position: relative; z-index: 3; display: flex; flex-direction: column-reverse; gap: 2px; margin-top: auto; padding-top: 24px;
        }
        
        .event {
            font-size: 8px; color: white; padding: 2px 4px; border-radius: 4px; white-space: normal; overflow: hidden; font-weight: 500; line-height: 1.2; max-width: 100%;
        }

        .event.work-event {
            flex-grow: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2px; color: #2c2c2e; font-weight: 600; overflow: hidden; text-overflow: ellipsis; font-size: 10px; line-height: 1.3;
        }
        
        .event.work-event small {
            font-size: 0.8em; opacity: 0.8; display: block; font-weight: 500;
        }

        .event.vacation {
            width: 100%; padding: 2px 3px; border-radius: 2px; text-align: center; white-space: nowrap; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; gap: 4px; color: #fff;
        }
        
        .toggle-container {
            display: flex; align-items: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;
        }
        
        .toggle {
            position: relative; width: 40px; height: 22px; background: #ccc; border-radius: 11px; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0;
        }
        
        .toggle .toggle-slider {
            position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: transform 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle.active {
            background: #667eea;
        }
        
        .toggle.active .toggle-slider {
            transform: translateX(18px);
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; padding: 20px;
        }
        
        .modal-content {
            background: white; padding: 15px; border-radius: 12px; width: calc(100% - 20px); max-width: 380px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: modalSlideIn 0.3s ease; margin: 10px;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.8) translateY(-50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .day-events-list {
            margin-top: 20px; display: flex; flex-direction: column; gap: 12px;
        }

        .day-event-item {
            background: #f8f9fa; border-radius: 8px; padding: 12px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        
        .day-event-item.vacation {
            border-left-color: #28a745;
        }
        
        .day-event-info {
            flex: 1; min-width: 150px;
        }

        .day-event-info p {
            margin: 2px 0; font-size: 13px;
        }
        
        .day-event-info strong {
            font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px;
        }

        .day-event-actions {
            display: flex; gap: 8px; flex-shrink: 0;
        }
        
        .day-event-actions button {
            padding: 6px 10px; font-size: 12px; min-height: 36px;
        }

        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block; margin-bottom: 6px; font-weight: 600; color: #495057; font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%; padding: 12px 14px; border: 2px solid #e9ecef; border-radius: 10px; box-sizing: border-box; font-size: 14px; transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .equipment-row {
            display: flex; gap: 10px; align-items: center; margin-bottom: 10px;
        }
        .equipment-row select {
            flex: 3;
        }
        .equipment-row input {
            flex: 1;
        }
        .equipment-row .remove-btn {
            flex-shrink: 0; padding: 0; width: 36px; height: 36px; font-size: 18px; line-height: 36px; background: #f8d7da; color: #721c24; min-height: 0;
        }
        .add-pipe-btn {
            background: #d4edda; color: #155724; margin-top: 5px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; min-height: 44px; white-space: nowrap;
        }
        
        button:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .button-secondary {
            background: #6c757d;
        }
        
        .button-secondary:hover {
            background: #5a6268; box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }
        
        .button-danger {
            background: linear-gradient(135deg, #ff3b30, #dc3545);
        }
        
        .button-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 59, 48, 0.3);
        }
        
        .card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .inventory-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;
        }
        
        .inventory-item {
            background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;
        }
        
        .inventory-item:hover {
            transform: translateY(-6px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); border-color: #667eea;
        }
        
        .inventory-item-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        
        .inventory-item-title {
            font-weight: 600; font-size: 16px; color: #1d1d1f;
        }
        
        .inventory-item-amount {
            font-weight: bold; font-size: 20px; color: #667eea;
        }
        
        .inventory-item-warning {
            color: #ff3b30; font-size: 12px; margin-top: 6px; font-weight: 500;
        }
        
        .login-container {
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;
        }
        
        .login-form {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px 20px; width: 100%; max-width: 350px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .login-form h2 {
            text-align: center; margin-bottom: 25px; color: #1d1d1f; font-weight: 600; font-size: 22px;
        }
        
        .request-item {
            background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #ffc107; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .request-item.approved {
            border-left-color: #28a745;
        }
        
        .request-item.rejected {
            border-left-color: #dc3545;
        }
        
        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 11px; font-weight: 500; text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd; color: #856404;
        }
        
        .status-approved {
            background: #d4edda; color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da; color: #721c24;
        }
        
        .notification {
            position: fixed; top: 15px; right: 15px; background: #28a745; color: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); z-index: 1001; animation: slideInRight 0.3s ease; font-size: 13px; max-width: calc(100% - 30px);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .upcoming-events {
            background: white; border-radius: 12px; padding: 5px 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .upcoming-events.hidden {
            display: none;
        }

        .upcoming-events-header {
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px 0;
        }

        .upcoming-events-header h3 {
            margin: 0; color: #1d1d1f; font-weight: 600; font-size: 16px;
        }

        .upcoming-events-icons {
            display: flex; gap: 8px; font-size: 18px; margin-left: auto; margin-right: 15px;
        }

        .upcoming-events-list {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
        }

        .upcoming-events.expanded .upcoming-events-list {
            max-height: 500px;
        }
        
        .upcoming-events-header .arrow {
            transition: transform 0.3s ease;
        }

        .upcoming-events.expanded .arrow {
            transform: rotate(180deg);
        }
        
        .upcoming-event {
            padding: 8px 0; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 8px; font-size: 13px;
        }
        
        .upcoming-event:last-child {
            border-bottom: none;
        }
        
        .event-indicator {
            width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
        }
        
        .month-navigation {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 12px 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .month-navigation h2 {
            margin: 0; color: #1d1d1f; font-weight: 600; font-size: 18px;
        }
        
        .nav-button {
            background: #667eea; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; min-height: 40px;
        }
        
        .nav-button:hover {
            background: #5a67d8; transform: scale(1.1);
        }
        
        .comment-section {
            margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef;
        }
        
        .comment {
            background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 6px; font-size: 12px;
        }
        
        .comment-author {
            font-weight: 600; color: #667eea;
        }
        
        .add-comment {
            display: flex; gap: 6px; margin-top: 8px;
        }
        
        .comment-input {
            flex: 1; padding: 8px 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 13px;
        }
        
        .comment-btn {
            padding: 8px 12px; font-size: 12px; min-height: 38px;
        }
        
        .table-responsive {
            overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 15px;
        }
        
        table {
            width: 100%; border-collapse: collapse; background-color: white; overflow: hidden; font-size: 12px;
        }
        
        th, td {
            padding: 10px 12px; text-align: left; border-bottom: 1px solid #d2d2d7; white-space: nowrap;
        }
        
        th {
            background-color: #f5f5f7; font-weight: 500;
        }
        
        .employee-chip {
            display: inline-block; padding: 4px 10px; border-radius: 12px; margin-right: 4px; margin-bottom: 4px; font-size: 12px; line-height: 1.2;
        }
        
        .chip-selector {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;
        }
        
        .chip-option {
            background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 8px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.3s ease; user-select: none; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;
        }
        
        .chip-option:hover {
            background: #e9ecef; transform: translateY(-1px);
        }
        
        .chip-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .chip-option.team-color {
            color: #2c2c2e; font-weight: 600; border: 2px solid rgba(0,0,0,0.1);
        }
        
        .chip-option.team-color.selected {
            transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); border: 2px solid #333;
        }
        
        .event-type-selector,
        .role-selector,
        .operation-type-selector,
        .team-type-selector {
            display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;
        }
        
        .event-type-option,
        .role-option,
        .operation-type-option,
        .team-type-option {
            flex: 1; background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 12px 14px; border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s ease; text-align: center; user-select: none; min-width: 100px;
        }
        
        .event-type-option.selected,
        .role-option.selected,
        .operation-type-option.selected,
        .team-type-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .operation-type-option.income {
            background: #d4edda; border-color: #c3e6cb; color: #155724;
        }
        
        .operation-type-option.income.selected {
            background: linear-gradient(135deg, #28a745, #20c997); color: white; border-color: #28a745;
        }
        
        .operation-type-option.expense {
            background: #f8d7da; border-color: #f5c6cb; color: #721c24;
        }
        
        .operation-type-option.expense.selected {
            background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-color: #dc3545;
        }
        
        .button-group {
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
        }
        
        .modal .button-group-end {
            display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; flex-wrap: wrap;
        }

    </style>
</head>
<body>
    <div id="login-screen" class="login-container"></div>
    <div id="main-app" style="display: none;"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize HTML structure on load
        document.getElementById('login-screen').innerHTML = `
            <div class="login-form">
                <h2>Вход в систему</h2>
                <div class="form-group">
                    <label for="username">Имя пользователя</label>
                    <input type="text" id="username" placeholder="Введите имя пользователя">
                </div>
                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" placeholder="Введите пароль">
                </div>
                <button onclick="login()" style="width: 100%;">Войти</button>
            </div>`;

        document.getElementById('main-app').innerHTML = `
        <div class="container">
            <div class="header" id="app-header">
                <h1>Управление бригадами и складом</h1>
                <div class="user-info">
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" onclick="logout()">Выход</button>
                </div>
            </div>
            <div class="upcoming-events hidden" id="upcoming-events" onclick="toggleUpcomingEvents()">
                <div class="upcoming-events-header">
                    <h3>Ближайшие события</h3>
                    <div class="upcoming-events-icons" id="upcoming-events-icons"></div>
                    <span class="arrow">▼</span>
                </div>
                <div class="upcoming-events-list" id="upcoming-events-list"></div>
            </div>
            <div class="main-content">
                <div id="calendar" class="tab-content active">
                    <div class="toggle-container">
                        <label>Показать отпуска:</label>
                        <div class="toggle active" id="vacation-toggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="month-navigation">
                        <button class="nav-button" onclick="prevMonth()">‹</button>
                        <h2 id="current-month"></h2>
                        <button class="nav-button" onclick="nextMonth()">›</button>
                    </div>
                    <div class="calendar">
                        <div class="calendar-header">Пн</div><div class="calendar-header">Вт</div><div class="calendar-header">Ср</div><div class="calendar-header">Чт</div><div class="calendar-header">Пт</div><div class="calendar-header">Сб</div><div class="calendar-header">Вс</div>
                    </div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <div id="teams" class="tab-content">
                    <h2>Управление бригадами</h2>
                    <button onclick="openTeamModal()" style="margin-bottom: 20px;">Добавить бригаду</button>
                    <div id="teams-list"></div>
                    <h2 style="margin-top: 30px;">Сотрудники</h2>
                    <button onclick="openEmployeeModal()" style="margin-bottom: 20px;">Добавить сотрудника</button>
                    <div id="employees-list"></div>
                </div>
                <div id="inventory" class="tab-content">
                    <h2>Учет склада</h2>
                    <div class="inventory-grid" id="inventory-grid"></div>
                </div>
                <div id="requests" class="tab-content">
                    <h2>Заявки</h2>
                    <div id="requests-list"></div>
                </div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab active" onclick="switchTab('calendar')"><span>📅</span><span>Календарь</span></button>
            <button class="tab" onclick="switchTab('teams')" id="teams-tab"><span>👥</span><span>Бригады</span></button>
            <button class="tab" onclick="switchTab('inventory')"><span>📦</span><span>Склад</span></button>
            <button class="tab" onclick="switchTab('requests')" id="requests-tab"><span>📋</span><span>Заявки</span></button>
        </div>
        <div id="event-modal" class="modal">
            <div class="modal-content">
                <h2 id="event-modal-title">Добавить событие</h2>
                <input type="hidden" id="event-id">
                <div class="form-group">
                    <label>Тип события</label>
                    <div class="event-type-selector">
                        <div class="event-type-option selected" onclick="selectEventType(this, 'drilling')">⛏️ Бурение</div>
                        <div class="event-type-option" onclick="selectEventType(this, 'installation')">🔧 Монтаж</div>
                        <div class="event-type-option" onclick="selectEventType(this, 'trip')">🚚 Поездка</div>
                        <div class="event-type-option" onclick="selectEventType(this, 'vacation')">🏖️ Отпуск</div>
                    </div>
                    <input type="hidden" id="event-type" value="drilling">
                </div>
                <div id="work-fields">
                    <div class="form-group"><label for="event-date">Дата</label><input type="date" id="event-date"></div>
                    <div class="form-group"><label for="event-address">Адрес объекта</label><input type="text" id="event-address" placeholder="Введите адрес объекта"></div>
                    <div class="form-group"><label>Бригада</label><div class="chip-selector" id="team-chips"></div><input type="hidden" id="event-team"></div>
                    <div class="form-group" id="equipment-form-group"><label>Что взять с собой (трубы)</label><div id="equipment-list"></div><button class="add-pipe-btn" onclick="addPipeRow()">+ Добавить трубу</button></div>
                    <div class="form-group" id="installation-equipment-group" style="display:none;"><label>Тип монтажа</label><select id="installation-type"><option value="Летнее">Летнее</option><option value="Адаптер">Адаптер</option><option value="Кессон">Кессон</option></select></div>
                </div>
                <div id="vacation-fields" style="display: none;">
                    <div class="form-group"><label>Сотрудник</label><div class="chip-selector" id="employee-chips"></div><input type="hidden" id="event-employee"></div>
                    <div class="form-group"><label for="event-start-date">Начало отпуска</label><input type="date" id="event-start-date"></div>
                    <div class="form-group"><label for="event-end-date">Конец отпуска</label><input type="date" id="event-end-date"></div>
                </div>
                <div class="button-group-end"><button class="button-secondary" onclick="closeModal('event-modal')">Отмена</button><button id="save-event-btn" onclick="saveEvent()">Сохранить</button></div>
            </div>
        </div>
        <div id="day-details-modal" class="modal">
            <div class="modal-content">
                <h2 id="day-details-title"></h2>
                <div id="day-events-list"></div>
                <div class="button-group-end">
                    <button class="button-secondary" onclick="closeModal('day-details-modal')">Закрыть</button>
                    <button id="add-event-from-day-btn" onclick="addEventFromDayView()">Добавить</button>
                    <button id="request-vacation-from-day-btn" onclick="requestVacationFromDayView()">Отпуск</button>
                </div>
            </div>
        </div>
        <div id="vacation-request-modal" class="modal">
            <div class="modal-content">
                <h2>Запрос на отпуск</h2>
                <div class="form-group"><label for="vacation-start-date">Начало отпуска</label><input type="date" id="vacation-start-date"></div>
                <div class="form-group"><label for="vacation-end-date">Конец отпуска</label><input type="date" id="vacation-end-date"></div>
                <div class="form-group"><label for="vacation-reason">Причина</label><textarea id="vacation-reason" placeholder="Укажите причину отпуска"></textarea></div>
                <div class="button-group-end"><button class="button-secondary" onclick="closeModal('vacation-request-modal')">Отмена</button><button onclick="submitVacationRequest()">Отправить</button></div>
            </div>
        </div>
        <div id="inventory-request-modal" class="modal">
            <div class="modal-content">
                <h2 id="inventory-request-title">Запрос материалов</h2>
                <div class="form-group"><label for="request-amount">Количество</label><input type="number" id="request-amount" min="1"></div>
                <div class="button-group-end"><button class="button-secondary" onclick="closeModal('inventory-request-modal')">Отмена</button><button onclick="submitInventoryRequest()">Отправить</button></div>
            </div>
        </div>
        <div id="event-details-modal" class="modal">
            <div class="modal-content">
                <h2 id="event-details-title"></h2>
                <div id="event-details-content"></div>
                <div class="comment-section" id="comment-section">
                    <h4>Комментарии</h4>
                    <div id="comments-list"></div>
                    <div class="add-comment" id="add-comment-form"><input type="text" id="new-comment" class="comment-input" placeholder="Добавить комментарий..."><button class="comment-btn" onclick="addComment()">Отправить</button></div>
                </div>
                <div class="button-group-end"><button onclick="closeModal('event-details-modal')">Закрыть</button></div>
            </div>
        </div>
        <div id="team-modal" class="modal">
            <div class="modal-content">
                <h2>Добавить бригаду</h2>
                <div class="form-group"><label for="team-name">Название</label><input type="text" id="team-name" placeholder="Введите название бригады"></div>
                <div class="form-group"><label>Тип бригады</label><div class="team-type-selector"><div class="team-type-option selected" onclick="selectTeamType(this,'drillers')">⛏️ Бурильщики</div><div class="team-type-option" onclick="selectTeamType(this,'installers')">🔧 Монтажники</div><div class="team-type-option" onclick="selectTeamType(this,'drivers')">🚚 Водители</div></div><input type="hidden" id="team-type" value="drillers"></div>
                <div class="form-group"><label>Цвет бригады</label><div class="chip-selector" id="color-chips">...</div><input type="hidden" id="team-color" value="#a7c7e7"></div>
                <div class="button-group-end"><button class="button-secondary" onclick="closeModal('team-modal')">Отмена</button><button onclick="saveTeam()">Сохранить</button></div>
            </div>
        </div>
        <div id="employee-modal" class="modal">
            <div class="modal-content">
                <h2>Добавить сотрудника</h2>
                <div class="form-group"><label for="employee-name">ФИО</label><input type="text" id="employee-name"></div>
                <div class="form-group"><label for="employee-username">Логин</label><input type="text" id="employee-username"></div>
                <div class="form-group"><label for="employee-password">Пароль</label><input type="password" id="employee-password"></div>
                <div class="form-group"><label>Роль</label><div class="role-selector"><div class="role-option selected" onclick="selectRole(this,'employee')">👤 Сотрудник</div><div class="role-option" onclick="selectRole(this,'manager')">👔 Управляющий</div></div><input type="hidden" id="employee-role" value="employee"></div>
                <div class="button-group-end"><button class="button-secondary" onclick="closeModal('employee-modal')">Отмена</button><button onclick="saveEmployee()">Сохранить</button></div>
            </div>
        </div>
        <div id="inventory-operation-modal" class="modal">
            <div class="modal-content">
                <h2 id="inventory-operation-title"></h2>
                <div class="form-group"><label>Тип</label><div class="operation-type-selector">...</div><input type="hidden" id="inventory-operation-type" value="in"></div>
                <div class="form-group"><label>Дата</label><input type="date" id="inventory-operation-date"></div>
                <div class="form-group"><label>Количество</label><input type="number" id="inventory-operation-amount" min="1"></div>
                <div class="form-group"><label>Примечания</label><input type="text" id="inventory-operation-notes"></div>
                <div class="button-group-end"><button class="button-secondary" onclick="closeModal('inventory-operation-modal')">Отмена</button><button onclick="saveInventoryOperation()">Сохранить</button></div>
            </div>
        </div>
        <div id="inventory-history-modal" class="modal">
            <div class="modal-content">
                <h2 id="inventory-history-title"></h2>
                <div><h3>Остаток: <span id="inventory-current-amount"></span></h3><button id="add-operation-btn" onclick="openInventoryOperationModal()">Добавить</button></div>
                <div class="table-responsive"><table><thead><tr><th>Дата</th><th>Тип</th><th>Кол-во</th><th>Прим.</th></tr></thead><tbody id="inventory-history-table"></tbody></table></div>
                <div class="button-group-end"><button onclick="closeModal('inventory-history-modal')">Закрыть</button></div>
            </div>
        </div>
        `;
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        document.getElementById('vacation-toggle').addEventListener('click', toggleVacations);
    });

    const users = { 'admin': { password: 'admin', role: 'manager', name: 'Администратор' }, 'employee': { password: 'employee', role: 'employee', name: 'Сотрудник Иванов' } };
    let currentUser = null;
    let showVacations = true;
    let currentDate = new Date();
    let selectedDate = null;
    let selectedInventoryItem = null;
    let selectedEventForDetails = null;
    let touchStartX = 0;
    const vacationColors = ['#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff', '#a0c4ff', '#bdb2ff'];
    let teams = [
        { id: 1, name: "Бурильщики 1", color: "#a7c7e7", type: 'drillers' },
        { id: 2, name: "Монтажники 1", color: "#98fb98", type: 'installers' },
        { id: 3, name: "Бурильщики 2", color: "#ffb347", type: 'drillers' },
        { id: 4, name: "Водитель 1", color: "#e6e6e6", type: 'drivers' }
    ];
    let employees = [
        { id: 1, name: "Иванов Иван", teamId: 1, role: 'employee', username: 'employee' },
        { id: 2, name: "Петров Петр", teamId: 1, role: 'employee' },
        { id: 3, name: "Сидоров Алексей", teamId: 2, role: 'employee' },
        { id: 4, name: "Кузнецова Анна", teamId: null, role: 'employee' }
    ];
    let events = [
        { id: 1, type: "drilling", date: formatDate(new Date()), address: "ул. Строителей, 15", teamId: 1, equipment: [{pipeId: 1, meters: 50}, {pipeId: 5, meters: 100}], comments: [] },
        { id: 2, type: "vacation", startDate: formatDate(new Date(new Date().setDate(new Date().getDate() + 2))), endDate: formatDate(new Date(new Date().setDate(new Date().getDate() + 9))), employeeId: 4, comments: [] },
        { id: 3, type: "installation", date: formatDate(new Date(new Date().setDate(new Date().getDate() + 4))), address: "пр. Мира, 1", teamId: 2, equipment: "Кессон", comments: [] },
        { id: 4, type: "drilling", date: formatDate(new Date(new Date().setDate(new Date().getDate() + 4))), address: "дер. Новая, 22", teamId: 3, equipment: [{pipeId: 3, meters: 100}], comments: [] },
        { id: 5, type: "trip", date: formatDate(new Date(new Date().setDate(new Date().getDate() + 1))), address: "Склад", teamId: 4, equipment: null, comments: [] }
    ];
    const pipeTypes = [
        { id: 1, name: "ПНД 125мм", minStock: 50 },
        { id: 2, name: "Металл 133мм", minStock: 30 },
        { id: 3, name: "ПНД 117мм", minStock: 40 },
        { id: 4, name: "нПВХ 90мм", minStock: 60 },
        { id: 5, name: "ПНД 32мм", minStock: 100 }
    ];
    let inventoryOperations = [
        { id: 1, itemId: 1, date: formatDate(new Date()), type: "in", amount: 100, notes: "Поставка от завода" },
        { id: 2, itemId: 1, date: formatDate(new Date()), type: "out", amount: 30, notes: "Бригада 1" },
        { id: 3, itemId: 2, date: formatDate(new Date()), type: "in", amount: 50, notes: "Поставка от завода" }
    ];
    let requests = [
        { id: 1, type: 'vacation', userId: 'employee', userName: 'Сотрудник Иванов', startDate: '2024-07-15', endDate: '2024-07-22', reason: 'Семейные обстоятельства', status: 'pending', createdAt: formatDate(new Date()) }
    ];
    function isWorkEvent(event) { return event.type === 'drilling' || event.type === 'installation' || event.type === 'trip'; }
    function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (users[username] && users[username].password === password) {
            currentUser = { username: username, ...users[username] };
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            initializeApp();
            showNotification('Добро пожаловать!');
        } else {
            showNotification('Неверные данные для входа', 'error');
        }
    }
    function logout() {
        currentUser = null;
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }
    function initializeApp() {
        document.getElementById('user-badge').textContent = `${currentUser.name} (${currentUser.role === 'manager' ? 'Управляющий' : 'Сотрудник'})`;
        document.getElementById('vacation-toggle').classList.toggle('active', showVacations);
        if (currentUser.role === 'employee') {
            document.getElementById('teams-tab').style.display = 'none';
            document.getElementById('requests-tab').style.display = 'none';
        } else {
            document.getElementById('teams-tab').style.display = 'flex';
            document.getElementById('requests-tab').style.display = 'flex';
            renderTeams();
            renderEmployees();
            renderRequests();
        }
        initializeSwipeEvents();
        renderInventoryGrid();
        switchTab('calendar');
    }
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        if (type === 'error') notification.style.background = '#ff3b30';
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
    }
    function formatDate(date) {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1), day = '' + d.getDate();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [d.getFullYear(), month, day].join('-');
    }
    function getMonthName(date) { return ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"][date.getMonth()] + " " + date.getFullYear(); }
    function getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
    function getFirstDayOfMonth(year, month) { const day = new Date(year, month, 1).getDay(); return day === 0 ? 6 : day - 1; }
    function getTeamName(id) { return teams.find(t => t.id === id)?.name || "Неизвестная бригада"; }
    function getTeamColor(id) { return teams.find(t => t.id === id)?.color || "#cccccc"; }
    function getVacationColor(employeeId) { return vacationColors[employeeId % vacationColors.length]; }
    function getEmployeeName(id) { return employees.find(e => e.id === id)?.name || "Неизвестный сотрудник"; }
    function getPipeTypeName(id) { return pipeTypes.find(t => t.id === id)?.name || "Неизвестный тип"; }
    function calculateCurrentAmount(itemId) { return inventoryOperations.filter(op => op.itemId === itemId).reduce((sum, op) => op.type === "in" ? sum + op.amount : sum - op.amount, 0); }
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        document.getElementById('app-header').classList.toggle('hidden', tabId !== 'requests');
        document.getElementById('upcoming-events').classList.toggle('hidden', tabId !== 'calendar');
        if (tabId === 'calendar') renderCalendar();
    }
    function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    function toggleVacations() {
        showVacations = !showVacations;
        document.getElementById('vacation-toggle').classList.toggle('active', showVacations);
        renderCalendar();
    }
    function renderCalendar() {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        document.getElementById('current-month').textContent = getMonthName(currentDate);
        const calendarDaysEl = document.getElementById('calendar-days');
        calendarDaysEl.innerHTML = '';
        for (let i = 0; i < getFirstDayOfMonth(year, month); i++) calendarDaysEl.innerHTML += `<div class="calendar-day other-month"></div>`;
        const today = formatDate(new Date());
        for (let day = 1; day <= getDaysInMonth(year, month); day++) {
            const formattedDate = formatDate(new Date(year, month, day));
            const workEvents = events.filter(e => isWorkEvent(e) && e.date === formattedDate);
            const vacationEvents = showVacations ? events.filter(e => e.type === 'vacation' && e.startDate <= formattedDate && e.endDate >= formattedDate) : [];
            let dayClasses = 'calendar-day';
            if (formattedDate === today) dayClasses += ' today';
            const workEventsHtml = workEvents.map(event => `<div class="event work-event" style="background-color: ${getTeamColor(event.teamId)};" title="${getTeamName(event.teamId)} - ${event.address}"><div>${{ drilling: '⛏️', installation: '🔧', trip: '🚚' }[event.type]} ${getTeamName(event.teamId).replace('Бурильщики','Бур.').replace('Монтажники','Монт.').replace('Водитель','Вод.')}<small>${event.address}</small></div></div>`).join('');
            const vacationEventsHtml = vacationEvents.map(event => `<div class="event vacation" style="background-color: ${getVacationColor(event.employeeId)};" title="${getEmployeeName(event.employeeId)} - отпуск">🏖️ ${getEmployeeName(event.employeeId).split(' ')[0]}</div>`).join('');
            const dayEl = document.createElement('div');
            dayEl.className = dayClasses;
            dayEl.onclick = () => openDayDetailsModal(formattedDate);
            dayEl.innerHTML = `<div class="work-events-wrapper">${workEventsHtml}</div><div class="day-number">${day}</div><div class="events-container"><div class="vacation-events-wrapper">${vacationEventsHtml}</div></div>`;
            calendarDaysEl.appendChild(dayEl);
        }
        const totalCells = getFirstDayOfMonth(year, month) + getDaysInMonth(year, month);
        for (let i = 0; i < (7 - totalCells % 7) % 7; i++) calendarDaysEl.innerHTML += `<div class="calendar-day other-month"></div>`;
        renderUpcomingEvents();
    }
    function getUpcomingEvents(days) {
        const today = new Date(); today.setHours(0,0,0,0);
        const upcoming = []; let daysWithEventsCount = 0;
        for (let i = 0; daysWithEventsCount < days; i++) {
            const checkDate = new Date(today); checkDate.setDate(today.getDate() + i);
            const formattedDate = formatDate(checkDate);
            const dayEvents = events.filter(e => (isWorkEvent(e) && e.date === formattedDate) || (e.type === 'vacation' && e.startDate === formattedDate));
            if (dayEvents.length > 0) {
                let dateLabel;
                if (daysWithEventsCount === 0) dateLabel = 'Сегодня';
                else if (daysWithEventsCount === 1) dateLabel = 'Завтра';
                else if (daysWithEventsCount === 2) dateLabel = 'Послезавтра';
                else dateLabel = formattedDate.split('-').reverse().join('.');
                upcoming.push({ dateLabel, events: dayEvents });
                daysWithEventsCount++;
            }
            if (i > 30) break;
        }
        return upcoming;
    }
    function toggleUpcomingEvents() { document.getElementById('upcoming-events').classList.toggle('expanded'); }
    function renderUpcomingEvents() {
        const upcomingForList = getUpcomingEvents(7);
        const upcomingForIcons = getUpcomingEvents(2);
        const listEl = document.getElementById('upcoming-events-list');
        const iconsEl = document.getElementById('upcoming-events-icons');
        const uniqueIcons = new Set();
        upcomingForIcons.forEach(day => day.events.forEach(event => { const icon = { drilling: '⛏️', installation: '🔧', trip: '🚚', vacation: '🏖️' }[event.type]; if(icon) uniqueIcons.add(icon); }));
        iconsEl.innerHTML = Array.from(uniqueIcons).join('');
        listEl.innerHTML = upcomingForList.length === 0 ? '<div style="color: #6c757d; font-style: italic; padding: 10px 0;">Нет предстоящих событий</div>' : upcomingForList.map(day => `<div style="margin-bottom: 10px; padding-top: 10px;"><strong>${day.dateLabel}:</strong></div>` + day.events.map(event => isWorkEvent(event) ? `<div class="upcoming-event"><div class="event-indicator" style="background-color: ${getTeamColor(event.teamId)};"></div><span>${getTeamName(event.teamId)} - ${event.address}</span></div>` : (showVacations && event.type === 'vacation' ? `<div class="upcoming-event"><div class="event-indicator" style="background-color: #34c759;"></div><span>${getEmployeeName(event.employeeId)} - отпуск</span></div>` : '')).join('')).join('');
    }
    function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }
    function initializeSwipeEvents() {
        const calendarGrid = document.getElementById('calendar-days');
        calendarGrid.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        calendarGrid.addEventListener('touchend', e => { const touchEndX = e.changedTouches[0].screenX; if (touchStartX - touchEndX > 50) nextMonth(); if (touchEndX - touchStartX > 50) prevMonth(); });
    }
    function openDayDetailsModal(date) {
        selectedDate = date;
        document.getElementById('day-details-title').textContent = `События на ${date.split('-').reverse().join('.')}`;
        const dayEvents = events.filter(e => (isWorkEvent(e) && e.date === date) || (e.type === 'vacation' && e.startDate <= date && e.endDate >= date));
        const listEl = document.getElementById('day-events-list');
        listEl.innerHTML = dayEvents.length === 0 ? '<div style="color: #6c757d; text-align: center; padding: 20px 0;">Нет событий на этот день.</div>' : dayEvents.map(event => {
            let actionsHtml = '';
            if (currentUser.role === 'manager') actionsHtml = `<div class="day-event-actions"><button class="button-secondary" onclick="editEvent(${event.id})">Изм.</button><button class="button-danger" onclick="deleteEvent(${event.id})">Удл.</button></div>`;
            else if (currentUser.role === 'employee' && isWorkEvent(event)) actionsHtml = `<div class="day-event-actions"><button class="button-secondary" onclick="openEventDetails(${event.id})">Детали</button></div>`;
            if (event.type === 'vacation') return `<div class="day-event-item vacation"><div class="day-event-info"><strong>🏖️ Отпуск</strong><p>${getEmployeeName(event.employeeId)}</p><p style="font-size: 12px; color: #6c757d;">${event.startDate.split('-').reverse().join('.')} - ${event.endDate.split('-').reverse().join('.')}</p></div>${actionsHtml}</div>`;
            if (isWorkEvent(event)) { const teamColor = getTeamColor(event.teamId); const eventTitle = { drilling: '⛏️ Бурение', installation: '🔧 Монтаж', trip: '🚚 Поездка' }[event.type]; return `<div class="day-event-item" style="border-left-color: ${teamColor}"><div class="day-event-info"><strong>${eventTitle}: ${getTeamName(event.teamId)}</strong><p>${event.address}</p></div>${actionsHtml}</div>`; }
            return '';
        }).join('');
        document.getElementById('add-event-from-day-btn').style.display = currentUser.role === 'manager' ? 'inline-block' : 'none';
        document.getElementById('request-vacation-from-day-btn').style.display = currentUser.role === 'employee' ? 'inline-block' : 'none';
        openModal('day-details-modal');
    }
    function addEventFromDayView() { closeModal('day-details-modal'); openEventModal(selectedDate); }
    function requestVacationFromDayView() { closeModal('day-details-modal'); openVacationRequestModal(selectedDate); }
    function editEvent(eventId) { const eventToEdit = events.find(e => e.id === eventId); if (!eventToEdit) return; closeModal('day-details-modal'); openEventModal(eventToEdit.date || eventToEdit.startDate, eventId); }
    function deleteEvent(eventId) { if (confirm('Вы уверены?')) { events = events.filter(e => e.id !== eventId); closeModal('day-details-modal'); renderCalendar(); showNotification('Событие удалено'); }}
    function openEventModal(date, eventId = null) {
        const isEditing = eventId !== null;
        const event = isEditing ? events.find(e => e.id === eventId) : null;
        selectedDate = date;
        document.getElementById('event-id').value = isEditing ? eventId : '';
        document.getElementById('event-modal-title').textContent = isEditing ? 'Редактировать событие' : 'Добавить событие';
        document.getElementById('save-event-btn').textContent = isEditing ? 'Сохранить изменения' : 'Сохранить';
        renderEmployeeChips();
        if (isEditing) {
            const eventType = event.type;
            selectEventType(document.querySelector(`.event-type-option[onclick*="'${eventType}'"]`), eventType);
            if (isWorkEvent(event)) { document.getElementById('event-date').value = event.date; document.getElementById('event-address').value = event.address; if(event.type === 'drilling') renderEquipmentList(event.equipment || []); if(event.type === 'installation') document.getElementById('installation-type').value = event.equipment; renderTeamChipsForEvent(eventType, event.teamId); }
            else if (event.type === 'vacation') { document.getElementById('event-start-date').value = event.startDate; document.getElementById('event-end-date').value = event.endDate; selectEmployee(document.querySelector(`#employee-chips .chip-option[onclick*="${event.employeeId}"]`), event.employeeId); }
        } else {
            document.getElementById('event-address').value = '';
            renderEquipmentList([]);
            selectEventType(document.querySelector('.event-type-selector .event-type-option'), 'drilling');
            const today = date || formatDate(new Date());
            document.getElementById('event-date').value = today;
            document.getElementById('event-start-date').value = today;
            document.getElementById('event-end-date').value = today;
        }
        openModal('event-modal');
    }
    function saveEvent() {
        const eventId = parseInt(document.getElementById('event-id').value);
        const isEditing = !isNaN(eventId);
        const type = document.getElementById('event-type').value;
        let newEventData;
        if (isWorkEvent({type})) {
            const date = document.getElementById('event-date').value, address = document.getElementById('event-address').value.trim(), teamId = parseInt(document.getElementById('event-team').value);
            let equipment = null;
            if (type === 'drilling') equipment = Array.from(document.querySelectorAll('#equipment-list .equipment-row')).map(row => ({ pipeId: parseInt(row.querySelector('select').value), meters: parseInt(row.querySelector('input').value) })).filter(item => !isNaN(item.pipeId) && !isNaN(item.meters) && item.meters > 0);
            else if (type === 'installation') equipment = document.getElementById('installation-type').value;
            if (!date || !address || !teamId) return showNotification('Заполните дату, адрес и выберите бригаду', 'error');
            newEventData = { type, date, address, teamId, equipment, comments: isEditing ? events.find(e => e.id === eventId).comments : [] };
        } else if (type === 'vacation') {
            const startDate = document.getElementById('event-start-date').value, endDate = document.getElementById('event-end-date').value, employeeId = parseInt(document.getElementById('event-employee').value);
            if (!startDate || !endDate || !employeeId) return showNotification('Заполните даты и выберите сотрудника', 'error');
            newEventData = { type, startDate, endDate, employeeId, comments: isEditing ? events.find(e => e.id === eventId).comments : [] };
        }
        if (isEditing) { const i = events.findIndex(e => e.id === eventId); if (i > -1) events[i] = { ...events[i], ...newEventData }; } else { events.push({ id: Date.now(), ...newEventData }); }
        closeModal('event-modal');
        renderCalendar();
        showNotification(isEditing ? 'Событие обновлено' : 'Событие добавлено');
    }
    function addPipeRow() { const list = document.getElementById('equipment-list'), newRow = document.createElement('div'); newRow.className = 'equipment-row'; newRow.innerHTML = `<select>${pipeTypes.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select><input type="number" placeholder="Метры" min="1"><button class="remove-btn" onclick="removePipeRow(this)">×</button>`; list.appendChild(newRow); }
    function removePipeRow(button) { button.parentElement.remove(); }
    function renderEquipmentList(equipmentData) {
        const list = document.getElementById('equipment-list'); list.innerHTML = '';
        const data = (Array.isArray(equipmentData) && equipmentData.length > 0) ? equipmentData : [null];
        data.forEach(item => { const newRow = document.createElement('div'); newRow.className = 'equipment-row'; newRow.innerHTML = `<select>${pipeTypes.map(p => `<option value="${p.id}" ${item && p.id === item.pipeId ? 'selected' : ''}>${p.name}</option>`).join('')}</select><input type="number" placeholder="Метры" min="1" value="${item ? item.meters : ''}"><button class="remove-btn" onclick="removePipeRow(this)">×</button>`; list.appendChild(newRow); });
    }
    function selectEventType(element, type) {
        if (!element) return;
        document.querySelectorAll('.event-type-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('event-type').value = type;
        const isWork = isWorkEvent({type});
        document.getElementById('work-fields').style.display = isWork ? 'block' : 'none';
        document.getElementById('vacation-fields').style.display = type === 'vacation' ? 'block' : 'none';
        document.getElementById('equipment-form-group').style.display = type === 'drilling' ? 'block' : 'none';
        document.getElementById('installation-equipment-group').style.display = type === 'installation' ? 'block' : 'none';
        if (isWork) renderTeamChipsForEvent(type);
    }
    function selectChip(element) { if (!element) return; const parent = element.parentElement; parent.querySelectorAll('.chip-option').forEach(opt => opt.classList.remove('selected')); element.classList.add('selected'); }
    function selectTeam(element, teamId) { selectChip(element); document.getElementById('event-team').value = teamId; }
    function selectEmployee(element, employeeId) { selectChip(element); document.getElementById('event-employee').value = employeeId; }
    function selectTeamType(element, type) { selectChip(element); document.getElementById('team-type').value = type; }
    function selectRole(element, role) { selectChip(element); document.getElementById('employee-role').value = role; }
    function selectOperationType(element, type) { selectChip(element); document.getElementById('inventory-operation-type').value = type; }
    function renderTeamChipsForEvent(eventType, selectedTeamId = null) {
        const container = document.getElementById('team-chips');
        const teamType = { drilling: 'drillers', installation: 'installers', trip: 'drivers' }[eventType];
        const filteredTeams = teams.filter(team => team.type === teamType);
        container.innerHTML = filteredTeams.map(team => `<div class="chip-option team-color" style="background-color: ${team.color};" onclick="selectTeam(this, ${team.id})">${team.name}</div>`).join('');
        if (filteredTeams.length > 0) {
            let teamToSelect = filteredTeams.find(t => t.id === selectedTeamId) || filteredTeams[0];
            const chipToSelect = container.querySelector(`.chip-option[onclick*="${teamToSelect.id}"]`);
            if (chipToSelect) { chipToSelect.classList.add('selected'); document.getElementById('event-team').value = teamToSelect.id; }
        } else {
            container.innerHTML = `<i style="color: #6c757d;">Нет бригад этого типа.</i>`;
            document.getElementById('event-team').value = '';
        }
    }
    function renderEmployeeChips() {
        const container = document.getElementById('employee-chips');
        container.innerHTML = employees.map(e => `<div class="chip-option" onclick="selectEmployee(this, ${e.id})">${e.name}</div>`).join('');
        if (employees.length > 0) { container.children[0]?.classList.add('selected'); document.getElementById('event-employee').value = employees[0].id; }
    }
    function openEventDetails(eventId) {
        selectedEventForDetails = events.find(e => e.id === eventId);
        if (!selectedEventForDetails) return;
        closeModal('day-details-modal');
        let content = '';
        if (isWorkEvent(selectedEventForDetails)) {
            const eventTitle = { drilling: 'Бурение', installation: 'Монтаж', trip: 'Поездка' }[selectedEventForDetails.type];
            let equipmentList = '<li>Не указано</li>';
            if (selectedEventForDetails.type === 'drilling' && Array.isArray(selectedEventForDetails.equipment)) equipmentList = selectedEventForDetails.equipment.map(item => `<li>${getPipeTypeName(item.pipeId)} - ${item.meters} м.</li>`).join('') || '<li>Не указано</li>';
            else if (selectedEventForDetails.type === 'installation') equipmentList = `<li>${selectedEventForDetails.equipment}</li>`;
            content = `<p><strong>Тип:</strong> ${eventTitle}</p><p><strong>Дата:</strong> ${selectedEventForDetails.date.split('-').reverse().join('.')}</p><p><strong>Бригада:</strong> ${getTeamName(selectedEventForDetails.teamId)}</p><p><strong>Адрес:</strong> ${selectedEventForDetails.address}</p><p><strong>Оборудование:</strong></p><ul style="margin-top: 5px; padding-left: 20px;">${equipmentList}</ul>`;
        } else content = `<p><strong>Тип:</strong> Отпуск</p><p><strong>Сотрудник:</strong> ${getEmployeeName(selectedEventForDetails.employeeId)}</p><p><strong>Период:</strong> ${selectedEventForDetails.startDate.split('-').reverse().join('.')} - ${selectedEventForDetails.endDate.split('-').reverse().join('.')}</p>`;
        document.getElementById('event-details-title').textContent = 'Детали события';
        document.getElementById('event-details-content').innerHTML = content;
        document.getElementById('comment-section').style.display = 'block';
        document.getElementById('add-comment-form').style.display = currentUser.role === 'manager' ? 'flex' : 'none';
        renderComments();
        openModal('event-details-modal');
    }
    function addComment() {
        const commentText = document.getElementById('new-comment').value.trim();
        if (!commentText || !selectedEventForDetails) return;
        selectedEventForDetails.comments = selectedEventForDetails.comments || [];
        selectedEventForDetails.comments.push({ author: currentUser.name, text: commentText, date: formatDate(new Date()) });
        document.getElementById('new-comment').value = '';
        renderComments();
        showNotification('Комментарий добавлен');
    }
    function renderComments() { document.getElementById('comments-list').innerHTML = (selectedEventForDetails?.comments?.length > 0) ? selectedEventForDetails.comments.map(c => `<div class="comment"><span class="comment-author">${c.author}:</span><span>${c.text}</span><div style="font-size: 11px; color: #6c757d; margin-top: 4px;">${c.date.split('-').reverse().join('.')}</div></div>`).join('') : '<div style="color: #6c757d; font-style: italic;">Нет комментариев</div>'; }
    function openVacationRequestModal(startDate = null) {
        document.getElementById('vacation-start-date').value = startDate || '';
        document.getElementById('vacation-end-date').value = '';
        document.getElementById('vacation-reason').value = '';
        openModal('vacation-request-modal');
    }
    function submitVacationRequest() {
        const startDate = document.getElementById('vacation-start-date').value, endDate = document.getElementById('vacation-end-date').value, reason = document.getElementById('vacation-reason').value;
        if (!startDate || !endDate || !reason.trim()) return showNotification('Заполните все поля', 'error');
        requests.push({ id: Date.now(), type: 'vacation', userId: currentUser.username, userName: currentUser.name, startDate, endDate, reason, status: 'pending', createdAt: formatDate(new Date()) });
        closeModal('vacation-request-modal');
        showNotification('Заявка на отпуск отправлена');
        if (currentUser.role === 'manager') renderRequests();
    }
    function renderRequests() {
        document.getElementById('requests-list').innerHTML = (requests.length === 0) ? '<div class="card">Нет заявок</div>' : requests.map(r => {
            const sClass = `status-${r.status}`, sText = { pending: 'Ожидает', approved: 'Одобрена', rejected: 'Отклонена'}[r.status];
            let details = '';
            if (r.type === 'vacation') details = `<h4 style="margin:0 0 8px 0">Заявка на отпуск</h4><p><strong>Сотрудник:</strong> ${r.userName}</p><p><strong>Период:</strong> ${r.startDate.split('-').reverse().join('.')} - ${r.endDate.split('-').reverse().join('.')}</p><p><strong>Причина:</strong> ${r.reason}</p>`;
            else if (r.type === 'inventory') details = `<h4 style="margin:0 0 8px 0">Заявка на материалы</h4><p><strong>Сотрудник:</strong> ${r.userName}</p><p><strong>Материал:</strong> ${getPipeTypeName(r.itemId)}</p><p><strong>Количество:</strong> ${r.amount}</p>`;
            const controls = (currentUser.role === 'manager' && r.status === 'pending') ? `<div class="button-group" style="margin-top:10px"><button onclick="handleRequest(${r.id},true)" style="padding:6px 12px;font-size:12px;min-height:38px">Одобрить</button><button onclick="handleRequest(${r.id},false)" class="button-danger" style="padding:6px 12px;font-size:12px;min-height:38px">Отклонить</button></div>` : '';
            return `<div class="request-item ${r.status}"><div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px"><div style="flex:1;min-width:200px">${details}<p style="margin:4px 0;font-size:12px;color:#6c757d">Подана: ${r.createdAt.split('-').reverse().join('.')}</p></div><div style="text-align:right;flex-shrink:0"><span class="status-badge ${sClass}">${sText}</span>${controls}</div></div></div>`;
        }).join('');
    }
    function handleRequest(requestId, isApproved) {
        const request = requests.find(r => r.id === requestId);
        if (!request) return;
        request.status = isApproved ? 'approved' : 'rejected';
        if (isApproved) {
            if (request.type === 'vacation') { const employeeId = employees.find(e => e.name === request.userName)?.id; if (employeeId) events.push({ id: Date.now(), type: 'vacation', startDate: request.startDate, endDate: request.endDate, employeeId, comments: [] }); renderCalendar(); }
            else if (request.type === 'inventory') { inventoryOperations.push({ id: Date.now(), itemId: request.itemId, date: formatDate(new Date()), type: 'out', amount: request.amount, notes: `Выдано по заявке: ${request.userName}` }); renderInventoryGrid(); }
        }
        showNotification(isApproved ? 'Заявка одобрена' : 'Заявка отклонена');
        renderRequests();
    }
    function openInventoryRequestModal(itemId) {
        selectedInventoryItem = itemId;
        document.getElementById('inventory-request-title').textContent = `Запрос: ${itemId === 0 ? "Дизельное топливо" : getPipeTypeName(itemId)}`;
        document.getElementById('request-amount').value = '';
        openModal('inventory-request-modal');
    }
    function submitInventoryRequest() {
        const amount = parseInt(document.getElementById('request-amount').value);
        if (!amount || amount <= 0) return showNotification('Укажите корректное количество', 'error');
        requests.push({ id: Date.now(), type: 'inventory', userId: currentUser.username, userName: currentUser.name, itemId: selectedInventoryItem, amount, status: 'pending', createdAt: formatDate(new Date()) });
        closeModal('inventory-request-modal');
        showNotification('Заявка на материалы отправлена');
        if(currentUser.role === 'manager') renderRequests();
    }
    function renderTeams() {
        document.getElementById('teams-list').innerHTML = teams.map(team => {
            const teamEmployeesHtml = employees.filter(e => e.teamId === team.id).map(e => `<span class="employee-chip" style="background-color:${team.color}80;color:#333;border:1px solid ${team.color}">${e.name}<span onclick="removeEmployeeFromTeam(${e.id},event)" style="margin-left:5px;cursor:pointer;color:#ff3b30">×</span></span>`).join('');
            const teamTypeLabels = { drillers: 'Бурильщики', installers: 'Монтажники', drivers: 'Водители' };
            const teamTypeLabel = teamTypeLabels[team.type] || 'Неизвестный тип';
            const unassignedEmployeesOptions = employees.filter(e => !e.teamId).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            return `<div class="card"><div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 15px;"><div><h3 style="margin: 0 0 5px 0;">${team.name}</h3><span style="font-size: 13px; color: #fff; background: #6c757d; padding: 3px 8px; border-radius: 10px;">${teamTypeLabel}</span></div><div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${team.color}; flex-shrink: 0;"></div></div><div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 5px;">${teamEmployeesHtml || '<i style="color: #6c757d;">Нет сотрудников</i>'}</div><div class="button-group" style="align-items: stretch;"><select id="add-to-team-${team.id}" style="flex: 1; min-width: 150px;" ${!unassignedEmployeesOptions ? 'disabled' : ''}><option value="">Добавить сотрудника</option>${unassignedEmployeesOptions}</select><button onclick="addEmployeeToTeam(${team.id})" ${!unassignedEmployeesOptions ? 'disabled' : ''}>Добавить</button><button onclick="deleteTeam(${team.id})" class="button-danger">Удалить</button></div></div>`;
        }).join('');
    }
    function renderEmployees() {
        document.getElementById('employees-list').innerHTML = employees.map(employee => `<div class="card"><div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;"><div style="flex: 1; min-width: 150px;"><div style="font-weight: 600; margin-bottom: 4px;">${employee.name}</div><div style="color: #6c757d; font-size: 14px;">${employee.role === 'manager' ? 'Управляющий' : 'Сотрудник'}</div></div><div class="button-group" style="align-items: stretch;"><button onclick="deleteEmployee(${employee.id})" class="button-danger">Удалить</button></div></div></div>`).join('');
    }
    function selectTeamColor(element, color) { selectChip(element); document.getElementById('team-color').value = color; }
    function openTeamModal() {
        document.getElementById('team-name').value = '';
        selectTeamColor(document.querySelector('#color-chips .chip-option'), '#a7c7e7');
        selectTeamType(document.querySelector('.team-type-selector .team-type-option'), 'drillers');
        openModal('team-modal');
    }
    function openEmployeeModal() {
        document.getElementById('employee-name').value = '';
        document.getElementById('employee-username').value = '';
        document.getElementById('employee-password').value = '';
        selectRole(document.querySelector('.role-selector .role-option'), 'employee');
        openModal('employee-modal');
    }
    function saveTeam() {
        const name = document.getElementById('team-name').value.trim();
        const color = document.getElementById('team-color').value;
        const type = document.getElementById('team-type').value;
        if (!name) return showNotification('Введите название бригады', 'error');
        teams.push({ id: Date.now(), name, color, type });
        closeModal('team-modal');
        renderTeams();
        showNotification('Бригада добавлена');
    }
    function saveEmployee() {
        const name = document.getElementById('employee-name').value.trim();
        const role = document.getElementById('employee-role').value;
        const username = document.getElementById('employee-username').value.trim();
        const password = document.getElementById('employee-password').value.trim();
        if (!name || !username || !password) return showNotification('Заполните все поля сотрудника', 'error');
        if (users[username]) return showNotification('Пользователь с таким логином уже существует', 'error');
        users[username] = { password, role, name };
        employees.push({ id: Date.now(), name, teamId: null, role, username });
        closeModal('employee-modal');
        renderTeams();
        renderEmployees();
        showNotification('Сотрудник добавлен');
    }
    function addEmployeeToTeam(teamId) {
        const select = document.getElementById(`add-to-team-${teamId}`);
        const employeeId = parseInt(select.value);
        if (employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (employee) {
                employee.teamId = teamId;
                renderTeams();
                showNotification('Сотрудник добавлен в бригаду');
            }
        }
    }
    function removeEmployeeFromTeam(employeeId, event) {
        event.stopPropagation();
        const employee = employees.find(e => e.id === employeeId);
        if (employee) {
            employee.teamId = null;
            renderTeams();
            showNotification('Сотрудник откреплен от бригады');
        }
    }
    function deleteTeam(teamId) {
        if (confirm("Удалить бригаду? Сотрудники будут откреплены.")) {
            teams = teams.filter(t => t.id !== teamId);
            employees.forEach(e => { if (e.teamId === teamId) e.teamId = null; });
            renderTeams();
            showNotification('Бригада удалена');
        }
    }
    function deleteEmployee(employeeId) {
        if (confirm("Удалить сотрудника?")) {
            const employeeToDelete = employees.find(e => e.id === employeeId);
            if (employeeToDelete && employeeToDelete.username) delete users[employeeToDelete.username];
            employees = employees.filter(e => e.id !== employeeId);
            renderTeams();
            renderEmployees();
            showNotification('Сотрудник удален');
        }
    }
    function renderInventoryGrid() {
        const grid = document.getElementById('inventory-grid');
        const allItems = [ ...pipeTypes.map(type => ({ ...type, isFuel: false })), { id: 0, name: "🛢️ Дизельное топливо", minStock: 100, isFuel: true } ];
        grid.innerHTML = allItems.map(item => {
            const currentAmount = calculateCurrentAmount(item.id);
            const needsRestock = currentAmount < item.minStock;
            const clickHandler = currentUser.role === 'manager' ? `openInventoryHistoryModal(${item.id})` : `openInventoryRequestModal(${item.id})`;
            return `<div class="inventory-item" onclick="${clickHandler}"><div class="inventory-item-header"><div class="inventory-item-title">${item.name}</div><div class="inventory-item-amount">${currentAmount}${item.isFuel ? ' л' : ''}</div></div>${needsRestock ? `<div class="inventory-item-warning">⚠️ Требуется пополнение (мин. ${item.minStock})</div>` : ''}<div style="margin-top: 10px; font-size: 14px; color: #6c757d;">${currentUser.role === 'manager' ? 'Нажмите для управления' : 'Нажмите для запроса'}</div></div>`;
        }).join('');
    }
    function openInventoryHistoryModal(itemId) {
        selectedInventoryItem = itemId;
        const item = itemId === 0 ? { name: "Дизельное топливо", isFuel: true } : pipeTypes.find(t => t.id === itemId);
        document.getElementById('inventory-history-title').textContent = `История: ${item.name}`;
        document.getElementById('inventory-current-amount').textContent = `${calculateCurrentAmount(itemId)}${item.isFuel ? ' л' : ''}`;
        document.getElementById('add-operation-btn').style.display = currentUser.role === 'manager' ? 'inline-block' : 'none';
        const tbody = document.getElementById('inventory-history-table');
        const operations = inventoryOperations.filter(op => op.itemId === itemId).sort((a, b) => new Date(b.date) - new Date(a.date));
        tbody.innerHTML = operations.length === 0 ? '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Нет операций</td></tr>' : operations.map(op => `<tr><td>${op.date.split('-').reverse().join('.')}</td><td>${op.type === 'in' ? '📈 Поступление' : '📉 Расход'}</td><td style="color: ${op.type === 'in' ? '#28a745' : '#dc3545'}; font-weight: 600;">${op.type === 'in' ? '+' : '-'}${op.amount}${item.isFuel ? ' л' : ''}</td><td style="white-space: normal;">${op.notes}</td></tr>`).join('');
        openModal('inventory-history-modal');
    }
    function openInventoryOperationModal() {
        const item = selectedInventoryItem === 0 ? { name: "Дизельное топливо" } : pipeTypes.find(t => t.id === selectedInventoryItem);
        document.getElementById('inventory-operation-title').textContent = `Операция: ${item.name}`;
        document.getElementById('inventory-operation-date').value = formatDate(new Date());
        document.getElementById('inventory-operation-amount').value = '';
        document.getElementById('inventory-operation-notes').value = '';
        selectOperationType(document.querySelector('.operation-type-selector .income'), 'in');
        openModal('inventory-operation-modal');
    }
    function saveInventoryOperation() {
        const type = document.getElementById('inventory-operation-type').value;
        const date = document.getElementById('inventory-operation-date').value;
        const amount = parseFloat(document.getElementById('inventory-operation-amount').value);
        const notes = document.getElementById('inventory-operation-notes').value;
        if (date && !isNaN(amount) && amount > 0) {
            inventoryOperations.push({ id: Date.now(), itemId: selectedInventoryItem, date, type, amount, notes });
            closeModal('inventory-operation-modal');
            openInventoryHistoryModal(selectedInventoryItem);
            renderInventoryGrid();
            showNotification('Операция добавлена');
        } else {
            showNotification('Заполните все поля корректно', 'error');
        }
    }
</script>
</body>
</html>